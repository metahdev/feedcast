# LiveKit Authentication - NO API KEYS IN iOS! ðŸ”

## Important: iOS App Does NOT Use API Keys

The iOS app **never** has LiveKit API keys. Authentication works through tokens generated by a server.

## Three Ways to Authenticate

### Option 1: Sandbox (Easiest for Development) âœ…

**What is it?**
- LiveKit Cloud's built-in token server
- No code required, just a Sandbox ID
- Perfect for development and testing

**Setup:**

1. **Create Sandbox Token Server**
   - Go to https://cloud.livekit.io/projects/p_/sandbox/templates/token-server
   - Click "Create Token Server"
   - Copy the **Sandbox ID** (looks like `sb_xxxxxxxxxxxxxxxx`)

2. **Add to Config.swift**
   ```swift
   static let liveKitSandboxId: String? = "sb_xxxxxxxxxxxxxxxx"
   ```

3. **Done!** The iOS app will automatically use the sandbox.

**How it works:**
```
iOS App â†’ Sandbox API â†’ LiveKit Cloud â†’ Returns token
       (uses Sandbox ID)    (validates)     (ready to connect)
```

---

### Option 2: Hardcoded Token (Quick Testing)

**What is it?**
- A temporary JWT token you generate manually
- Expires after a few hours
- Good for quick testing without any server

**Setup:**

1. **Generate Token**
   ```bash
   # Make sure you're authenticated
   lk cloud auth
   
   # Generate a token (expires in 6 hours)
   lk token create \
     --join \
     --room test-room \
     --identity test-user
   
   # Copy the output token
   ```

2. **Add to Config.swift**
   ```swift
   static let liveKitHardcodedToken: String? = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
   static let liveKitURL = "wss://your-project.livekit.cloud"
   ```

3. **Done!** But remember, token expires soon.

**How it works:**
```
iOS App â†’ Uses hardcoded token â†’ Connects directly to room
         (no server call needed)
```

---

### Option 3: Your Own Token Server (Production)

**What is it?**
- Your own backend endpoint that generates tokens
- Has the API keys (not the iOS app!)
- Required for production apps

**Setup:**

1. **Create Token Server**
   ```bash
   lk app create
   â†’ Select: token-server
   â†’ Name: feedcast-token-server
   
   cd feedcast-token-server
   npm install
   ```

2. **Add Environment Variables**
   
   Create `.env` file:
   ```bash
   LIVEKIT_API_KEY=APIxxxxxxxxxxxxx
   LIVEKIT_API_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   LIVEKIT_URL=wss://your-project.livekit.cloud
   ```

3. **Customize for Podcast Context** (Optional)
   
   Edit `src/index.ts` or `index.js`:
   ```typescript
   app.post('/token', async (req, res) => {
     const { roomName, participantName, metadata } = req.body;
     
     const at = new AccessToken(
       process.env.LIVEKIT_API_KEY,
       process.env.LIVEKIT_API_SECRET,
       {
         identity: participantName,
         metadata: JSON.stringify(metadata),  // Include podcast data
       }
     );
     
     at.addGrant({ 
       room: roomName,
       roomJoin: true,
       canPublish: true,
       canSubscribe: true 
     });
     
     res.json({ token: await at.toJwt() });
   });
   ```

4. **Run Server**
   ```bash
   npm start  # Runs on http://localhost:3000
   ```

5. **Deploy to Production**
   ```bash
   # Deploy to Vercel
   vercel deploy
   
   # Or Railway
   railway up
   
   # Or Render
   # (connect GitHub repo)
   ```

6. **iOS App Already Configured!**
   
   The code in `VoiceChatView.swift` will automatically use your token server:
   ```swift
   // Already implemented:
   private func fetchTokenFromServer(roomName: String, participantName: String) async throws -> String {
       let url = URL(string: "http://localhost:3000/token")!
       // For production: URL(string: "https://your-token-server.vercel.app/token")!
       
       // Sends podcast metadata
       let body = [
           "roomName": roomName,
           "participantName": participantName,
           "metadata": ["podcast": podcastMetadata]
       ]
       
       // Gets token back
   }
   ```

**How it works:**
```
iOS App â†’ Your Token Server â†’ Returns token
         (POST /token)         (generated with API keys)
                                      â†“
                            Stored in .env on server
                            NEVER sent to iOS app!
```

---

## Comparison Table

| Method | Difficulty | Use Case | Expires | Needs Server |
|--------|-----------|----------|---------|--------------|
| **Sandbox** | â­ Easy | Development | No | No (LiveKit handles it) |
| **Hardcoded Token** | â­ Easy | Quick Test | Yes (hours) | No |
| **Token Server** | â­â­â­ Medium | Production | No | Yes (you deploy) |

---

## Quick Start Guide

### For Development (Recommended):

```bash
# 1. Create sandbox token server
# https://cloud.livekit.io/projects/p_/sandbox/templates/token-server

# 2. Copy Sandbox ID and add to Config.swift
static let liveKitSandboxId: String? = "sb_xxxxxxxxxxxxxxxx"

# 3. That's it! Test the app.
```

### For Production:

```bash
# 1. Deploy token server
lk app create â†’ token-server
cd feedcast-token-server
vercel deploy

# 2. Update VoiceChatView.swift
let url = URL(string: "https://your-token-server.vercel.app/token")!

# 3. Deploy!
```

---

## Security Best Practices

### âœ… DO:
- Use Sandbox for development
- Deploy token server for production
- Keep API keys in server `.env` files
- Use HTTPS for token server in production
- Validate user authentication before issuing tokens

### âŒ DON'T:
- Put API keys in iOS app
- Commit API keys to Git
- Use hardcoded tokens in production
- Share tokens between users
- Keep tokens without expiration in production

---

## Troubleshooting

### "Failed to fetch token"

**If using Sandbox:**
- Check Sandbox ID is correct
- Verify at: https://cloud.livekit.io/projects/p_/sandbox

**If using Token Server:**
- Check server is running: `curl http://localhost:3000/token -X POST`
- Check logs for errors
- Verify `.env` file has correct API keys

**If using Hardcoded Token:**
- Token might be expired (generate new one)
- Check `liveKitURL` is correct

### "API keys not working"

**Remember:** iOS app doesn't use API keys directly!
- API keys go in token server `.env` file
- iOS app only uses Sandbox ID or calls token endpoint

### "Where do I get API keys?"

1. Go to https://cloud.livekit.io
2. Select your project
3. Go to **Settings** â†’ **Keys**
4. Copy **API Key** and **API Secret**
5. Put them in **token server** `.env` file (NOT in iOS app!)

---

## Current feedcast Configuration

In `Config.swift`:
```swift
// Option 1: Add Sandbox ID (easiest)
static let liveKitSandboxId: String? = nil  // â† Put your sandbox ID here

// Option 2: Add hardcoded token (testing)
static let liveKitHardcodedToken: String? = nil  // â† Or put token here

// Option 3: Token server (already configured in VoiceChatView.swift)
```

In `VoiceChatView.swift`:
```swift
private func fetchToken(roomName: String) async throws -> String {
    // Tries in order:
    // 1. Sandbox (if liveKitSandboxId is set)
    // 2. Hardcoded token (if liveKitHardcodedToken is set)  
    // 3. Token server (http://localhost:3000/token)
}
```

---

## Next Steps

1. âœ… **Choose authentication method** (Sandbox recommended)
2. âœ… **Add credentials to Config.swift**
3. âœ… **Test voice chat**
4. âœ… **Deploy token server for production** (when ready)

No API keys needed in iOS! ðŸŽ‰

